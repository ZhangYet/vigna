#+TITLE: gVisor 文档阅读笔记
#+OPTIONS: ^:nil
#+OPTIONS: num:nil
#+HTML_HEAD: <link rel="stylesheet" href="https://latex.now.sh/style.css">
* What is gVisor
** [[https://github.com/opencontainers/runtime-spec/blob/master/spec.md][OCI Runtime Spec]]
*** 五原则
*** Filesystem Bundle
#+BEGIN_EXAMPLE
a filesystem bundle - a set of files organized in a certain way, and containing all the necessary data and metadata for any compliant runtime to perform all standard operations against it
#+END_EXAMPLE

1. [[https://github.com/opencontainers/runtime-spec/blob/master/config.md][config.json]] *必须* 有且 *必须* 命名为 config.json ， *必须* 位于 bundle 的根目录。
2. container's root filesystem: 其实就是 config.json 里面 `root.path` 指定的 dir。
*** [[https://github.com/opencontainers/runtime-spec/blob/master/runtime.md][Runtime and lifecycle]]
runtime *必须* 能执行标准 operation，它需要维护一个在标准 operation 下转移的状态机。
**** state 
每个 runtime 的 state 包含如下字段

| property    | value             | desc                            | required       |
| ociVersion  | string            | 就是 OCI runtime spec 的版本号  | Y              |
| id          | string            | 在当前 host 上唯一的 id         | Y              |
| status      | enum string[fn:1] | 后面 lifecycle 章节，这个是重点 | Y              |
| pid         | int               | 进程号                          | 依赖平台和状态 |
| bundle      | string            | bundle dir                      | Y              |
| annotations | string            |                                 | N              | 

可以增加其他字段。
**** lifecycle
定义了标准的 opertion 以及整个流程（opertion 调用的次序以及错误处理，有若干个 opertion 出错只需要 warning 即可，另外还有调用 hook 的时机）。
*** config
**** ociVersion
版本号没啥好说的。
**** root
指定 root filesystem, 大部分平台都是 required。 可以是绝对路径也可以是相对路径。
**** mounts
array。runtime *必须* 按列表次序挂载。更多细节见[[https://man7.org/linux/man-pages/man2/mount.2.html][ mount(2)]] 和 [[https://man7.org/linux/man-pages/man8/mount.8.html][mount(8)]].
**** process
***** apparmorProfile
见 [[https://wiki.ubuntu.com/AppArmor][AppArmor 文档]]，这是一门 MAC 技术，具体来说，它支持配置程序对哪些目录有哪些权限。
* Footnotes

[fn:1] 可选值包括 creating, created, running, stopped 可以增加更多的状态，但是不能跟已有状态重合。 
